<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<script type="text/javascript" src="../build/three.min.js"></script>
<!-- JSModeler includes start -->
	<script type="text/javascript" src="../../src/core/jsm.js"></script>
	<script type="text/javascript" src="../../src/core/timer.js"></script>
	<script type="text/javascript" src="../../src/core/algorithm.js"></script>
	<script type="text/javascript" src="../../src/core/async.js"></script>
	<script type="text/javascript" src="../../src/core/check.js"></script>
	<script type="text/javascript" src="../../src/geometry/coord.js"></script>
	<script type="text/javascript" src="../../src/geometry/determinant.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordutils2d.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/matrix.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordsystem.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordsystemutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/sector.js"></script>
	<script type="text/javascript" src="../../src/geometry/sectorutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/line.js"></script>
	<script type="text/javascript" src="../../src/geometry/lineutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/box.js"></script>
	<script type="text/javascript" src="../../src/geometry/boxutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/sphere.js"></script>
	<script type="text/javascript" src="../../src/geometry/transformation.js"></script>
	<script type="text/javascript" src="../../src/geometry/transformationutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/plane.js"></script>
	<script type="text/javascript" src="../../src/geometry/planeutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/projection.js"></script>
	<script type="text/javascript" src="../../src/geometry/convexhull.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygon.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygonutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/octree.js"></script>
	<script type="text/javascript" src="../../src/geometry/bsptree.js"></script>
	<script type="text/javascript" src="../../src/geometry/utilities.js"></script>
	<script type="text/javascript" src="../../src/geometry/ray.js"></script>
	<script type="text/javascript" src="../../src/modeler/body.js"></script>
	<script type="text/javascript" src="../../src/modeler/model.js"></script>
	<script type="text/javascript" src="../../src/modeler/color.js"></script>
	<script type="text/javascript" src="../../src/modeler/light.js"></script>
	<script type="text/javascript" src="../../src/modeler/material.js"></script>
	<script type="text/javascript" src="../../src/modeler/adjacencylist.js"></script>
	<script type="text/javascript" src="../../src/modeler/bodyutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/textureutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/cututils.js"></script>
	<script type="text/javascript" src="../../src/modeler/generator.js"></script>
	<script type="text/javascript" src="../../src/modeler/camera.js"></script>
	<script type="text/javascript" src="../../src/modeler/explode.js"></script>
	<script type="text/javascript" src="../../src/modeler/exporter.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglebody.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglemodel.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglebodyutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/converter.js"></script>
	<script type="text/javascript" src="../../src/modeler/rayutils.js"></script>
	<script type="text/javascript" src="../../src/import/binaryreader.js"></script>
	<script type="text/javascript" src="../../src/import/importer.js"></script>
	<script type="text/javascript" src="../../src/import/importer3ds.js"></script>
	<script type="text/javascript" src="../../src/import/importerobj.js"></script>
	<script type="text/javascript" src="../../src/import/importerstl.js"></script>
	<script type="text/javascript" src="../../src/import/importercommon.js"></script>
	<script type="text/javascript" src="../../src/extras/solidgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/extgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/painter.js"></script>
	<script type="text/javascript" src="../../src/extras/drawing.js"></script>
	<script type="text/javascript" src="../../src/extras/subdivision.js"></script>
	<script type="text/javascript" src="../../src/extras/svgtomodel.js"></script>
	<script type="text/javascript" src="../../src/extras/csg.js"></script>
	<script type="text/javascript" src="../../src/extras/curves.js"></script>
	<script type="text/javascript" src="../../src/renderer/webglutils.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/pointcloudrenderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/rendererconverter.js"></script>
	<script type="text/javascript" src="../../src/viewer/jsonfileloader.js"></script>
	<script type="text/javascript" src="../../src/viewer/mouse.js"></script>
	<script type="text/javascript" src="../../src/viewer/touch.js"></script>
	<script type="text/javascript" src="../../src/viewer/navigation.js"></script>
	<script type="text/javascript" src="../../src/viewer/softwareviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/spriteviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/viewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/pointcloudviewer.js"></script>
	<script type="text/javascript" src="../../src/three/threeconverter.js"></script>
	<script type="text/javascript" src="../../src/three/threeviewer.js"></script>
<!-- JSModeler includes end -->
	<script type="text/javascript" src="raytracer.js"></script>
	<title>Example</title>

	<script type="text/javascript">
		function GetModel (index)
		{
			var model = new JSM.Model ();
			var materials = new JSM.Materials ();
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0xcccccc}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0x00cc00}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0x0000ff}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0xcc0000, reflection : 0.2}));
			
			if (index < 3) {
				var body = JSM.GenerateCuboid (1, 1, 1);
				body.SetPolygonsMaterialIndex (1);
				body.Transform (JSM.RotationZTransformation (-0.35));
				body.Transform (JSM.TranslationTransformation (new JSM.Coord (-0.2, 1.2, 0.0)));
				model.AddBody (body);

				var body2 = JSM.GenerateCuboid (0.5, 0.5, 0.5);
				body2.SetPolygonsMaterialIndex (2);
				body2.Transform (JSM.TranslationTransformation (new JSM.Coord (1.2, 0.0, -0.25)));
				model.AddBody (body2);
			}

			if (index == 0) {
				var body3 = JSM.GenerateCuboid (3, 0.1, 2);
				body3.SetPolygonsMaterialIndex (3);
				body3.Transform (JSM.RotationZTransformation (-0.3));
				body3.Transform (JSM.TranslationTransformation (new JSM.Coord (0.0, -0.7, 0.5)));
				model.AddBody (body3);
			} else if (index == 1) {
				var body3 = JSM.GenerateCylinder (1.0, 2.0, 50, true, true);
				body3.SetPolygonsMaterialIndex (3);
				body3.Transform (JSM.RotationZTransformation (-0.3));
				body3.Transform (JSM.TranslationTransformation (new JSM.Coord (-1.0, -1.0, 0.0)));
				model.AddBody (body3);
			} else if (index == 2) {
				var body3 = JSM.GenerateSphere (1.0, 25, true);
				body3.SetPolygonsMaterialIndex (3);
				body3.Transform (JSM.RotationZTransformation (-0.3));
				body3.Transform (JSM.TranslationTransformation (new JSM.Coord (-0.8, -0.8, 0.5)));
				model.AddBody (body3);
			} else if (index == 3) {
				var body3 = JSM.GenerateLegoBrick (3, 2, true, true, false, 30, true);
				body3.SetPolygonsMaterialIndex (2);
				body3.Transform (JSM.RotationZTransformation (-0.5));
				body3.Transform (JSM.TranslationTransformation (new JSM.Coord (-0.8, 0.0, -0.5)));
				model.AddBody (body3);
			}

			var box = JSM.GenerateCuboid (10, 10, 10);
			box.SetPolygonsMaterialIndex (0);
			JSM.MakeBodyInsideOut (box);
			box.Transform (JSM.TranslationTransformation (new JSM.Coord (0.0, 0.0, 4.5)));
			model.AddBody (box);
			
			return JSM.ConvertModelToTriangleModel (model, materials);
		}

		function RayTrace (model, onFinish)
		{
			var size = 400;
			var sampleCount = 16;
			var rectSize = 50;

			var renders = document.getElementById ('renders');
			var canvas = document.createElement ('canvas');
			canvas.width = size;
			canvas.height = size;
			renders.appendChild (canvas);
			
			var camera = new JSM.Camera (
				new JSM.Coord (4, 1, 2),
				new JSM.Coord (0, 0, 0),
				new JSM.Coord (0, 0, 1)
			);
			var lights = [
				{
					position : new JSM.Coord (4, 2, 3),
					radius : 0.5,
					ambientIntensity : 1.0,
					diffuseIntensity : 1.0
				}				
			];
			
			var rayTracer = new RayTracer ();
			rayTracer.Init (canvas);
			rayTracer.Render ('PathTrace', model, camera, lights, sampleCount, rectSize, onFinish);
		}

		function RayTraceCurrent (index)
		{
			if (index > 2) {
				return;
			}
			
			var logDiv = document.getElementById ('log');
			var model = GetModel (index);
			var timer = new JSM.Timer ();
			timer.Start ();
			RayTrace (model, function () {
				timer.Stop ();
				logDiv.innerHTML += 'Elapsed time: ' + timer.Result () + '<br>';
				RayTraceCurrent (index + 1);
			});
		}
		
		function Load ()
		{
			RayTraceCurrent (0);
		}
	
	    window.onload = function ()
		{
			Load ();			
		}
	</script>

</head>

<body>
	<div id="renders"></div>
	<div id="log"></div>
</body>

</html>
