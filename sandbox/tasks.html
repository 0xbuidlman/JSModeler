<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<title>Example</title>

	<script type="text/javascript">
		function AddToLog (text)
		{
			var log = document.getElementById ('log');
			log.innerHTML += text + ' ';
		}

		var JSM = {};
		
		JSM.AsyncEnvironment = function (parameters)
		{
			this.parameters = parameters;
		};

		JSM.AsyncEnvironment.prototype.OnStart = function (taskCount)
		{
			if (this.parameters !== undefined && this.parameters.onStart !== undefined) {
				this.parameters.onStart (taskCount);
			}
		};

		JSM.AsyncEnvironment.prototype.OnProcess = function (currentTask)
		{
			if (this.parameters !== undefined && this.parameters.onProcess !== undefined) {
				this.parameters.onProcess (currentTask);
			}
		};

		JSM.AsyncEnvironment.prototype.OnFinish = function ()
		{
			if (this.parameters !== undefined && this.parameters.onFinish !== undefined) {
				this.parameters.onFinish ();
			}
		};

		JSM.AsyncRunTasks = function (parameters)
		{
			function GetTimeout ()
			{
				if (parameters.timeout !== undefined) {
					return parameters.timeout;
				}
				return 0;
			}

			function RunTask (environment, counter)
			{
				var needContinue = parameters.taskFunction ();
				environment.OnProcess (counter);
				if (needContinue && counter < parameters.runCount - 1) {
					setTimeout (function () {
						RunTask (environment, counter + 1);
					}, GetTimeout ());
					return;
				}
				environment.OnFinish ();
			}
			
			if (parameters === undefined || parameters.taskFunction === undefined || parameters.runCount === undefined) {
				return;
			}

			var environment = parameters.environment;
			if (environment === undefined) {
				environment = new JSM.AsyncEnvironment ();
			}
			
			environment.OnStart (parameters.runCount);
			RunTask (environment, 0);
		};

		function Load ()
		{
			var myCounter = 0;
			var environment = new JSM.AsyncEnvironment ({
				onStart : function (runCount) {
					AddToLog ('start' + runCount);
				},				
				onProcess : function (counter) {
					AddToLog ('task' + counter);
				},	
				onFinish : function () {
					AddToLog ('finish');
				}
			});
			JSM.AsyncRunTasks ({
				taskFunction : function () {
					for (var i = 0; i < 100000; i++) {
						var j = Math.sqrt (i);
						j = j + 1;
					}
					myCounter++;
					return true;
				},
				environment : environment,
				runCount : 100,
				timeout : 0
			});
		}
	
	    window.onload = function ()
		{
			Load ();			
		}
	</script>

</head>

<body>
	<div id="log"></div>
</body>

</html>
