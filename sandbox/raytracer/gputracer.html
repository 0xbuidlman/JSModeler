<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<script type="text/javascript" src="../build/three.min.js"></script>
<!-- JSModeler includes start -->
	<script type="text/javascript" src="../../src/core/jsm.js"></script>
	<script type="text/javascript" src="../../src/core/timer.js"></script>
	<script type="text/javascript" src="../../src/core/algorithm.js"></script>
	<script type="text/javascript" src="../../src/core/async.js"></script>
	<script type="text/javascript" src="../../src/core/check.js"></script>
	<script type="text/javascript" src="../../src/geometry/coord.js"></script>
	<script type="text/javascript" src="../../src/geometry/determinant.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/matrix.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordsystem.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordsystemutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/sector.js"></script>
	<script type="text/javascript" src="../../src/geometry/sectorutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/line.js"></script>
	<script type="text/javascript" src="../../src/geometry/lineutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/box.js"></script>
	<script type="text/javascript" src="../../src/geometry/boxutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/sphere.js"></script>
	<script type="text/javascript" src="../../src/geometry/transformation.js"></script>
	<script type="text/javascript" src="../../src/geometry/transformationutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/plane.js"></script>
	<script type="text/javascript" src="../../src/geometry/planeutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/projection.js"></script>
	<script type="text/javascript" src="../../src/geometry/convexhull.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygon.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygonutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/octree.js"></script>
	<script type="text/javascript" src="../../src/geometry/bsptree.js"></script>
	<script type="text/javascript" src="../../src/geometry/utilities.js"></script>
	<script type="text/javascript" src="../../src/geometry/ray.js"></script>
	<script type="text/javascript" src="../../src/modeler/body.js"></script>
	<script type="text/javascript" src="../../src/modeler/model.js"></script>
	<script type="text/javascript" src="../../src/modeler/color.js"></script>
	<script type="text/javascript" src="../../src/modeler/light.js"></script>
	<script type="text/javascript" src="../../src/modeler/material.js"></script>
	<script type="text/javascript" src="../../src/modeler/adjacencylist.js"></script>
	<script type="text/javascript" src="../../src/modeler/bodyutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/textureutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/cututils.js"></script>
	<script type="text/javascript" src="../../src/modeler/generator.js"></script>
	<script type="text/javascript" src="../../src/modeler/camera.js"></script>
	<script type="text/javascript" src="../../src/modeler/explode.js"></script>
	<script type="text/javascript" src="../../src/modeler/exporter.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglebody.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglemodel.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglebodyutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/converter.js"></script>
	<script type="text/javascript" src="../../src/modeler/rayutils.js"></script>
	<script type="text/javascript" src="../../src/import/binaryreader.js"></script>
	<script type="text/javascript" src="../../src/import/importer.js"></script>
	<script type="text/javascript" src="../../src/import/importer3ds.js"></script>
	<script type="text/javascript" src="../../src/import/importerobj.js"></script>
	<script type="text/javascript" src="../../src/import/importerstl.js"></script>
	<script type="text/javascript" src="../../src/import/importercommon.js"></script>
	<script type="text/javascript" src="../../src/extras/solidgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/extgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/painter.js"></script>
	<script type="text/javascript" src="../../src/extras/drawing.js"></script>
	<script type="text/javascript" src="../../src/extras/subdivision.js"></script>
	<script type="text/javascript" src="../../src/extras/svgtomodel.js"></script>
	<script type="text/javascript" src="../../src/extras/csg.js"></script>
	<script type="text/javascript" src="../../src/extras/curves.js"></script>
	<script type="text/javascript" src="../../src/renderer/webglutils.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/pointcloudrenderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/rendererconverter.js"></script>
	<script type="text/javascript" src="../../src/viewer/jsonfileloader.js"></script>
	<script type="text/javascript" src="../../src/viewer/mouse.js"></script>
	<script type="text/javascript" src="../../src/viewer/touch.js"></script>
	<script type="text/javascript" src="../../src/viewer/navigation.js"></script>
	<script type="text/javascript" src="../../src/viewer/softwareviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/spriteviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/viewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/pointcloudviewer.js"></script>
	<script type="text/javascript" src="../../src/three/threeconverter.js"></script>
	<script type="text/javascript" src="../../src/three/threeviewer.js"></script>
<!-- JSModeler includes end -->
	<title>Example</title>
	
	<style>
		html, body
		{
			margin : 5px;
			padding : 0px;
		}
	
		textarea.shadertext
		{
			width : 49%;
			height : 500px;
			border : 1px solid #cccccc;
		}
	</style>
	
	<script type="text/javascript">
		function GetModel (index)
		{
			var model = new JSM.Model ();
			var materials = new JSM.Materials ();
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0xcccccc}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0x00cc00}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0x0000ff}));
			materials.AddMaterial (new JSM.Material ({ambient : 0x000000, diffuse : 0xcc0000, reflection : 0.2}));
			
			var body = JSM.GenerateCuboid (1, 1, 1);
			body.SetPolygonsMaterialIndex (1);
			body.Transform (JSM.RotationZTransformation (-0.35));
			body.Transform (JSM.TranslationTransformation (new JSM.Coord (-0.2, 1.2, 0.0)));
			model.AddBody (body);

			var body2 = JSM.GenerateCuboid (0.5, 0.5, 0.5);
			body2.SetPolygonsMaterialIndex (2);
			body2.Transform (JSM.TranslationTransformation (new JSM.Coord (1.2, 0.0, -0.25)));
			model.AddBody (body2);

			var body3 = JSM.GenerateCuboid (3, 0.1, 2);
			body3.SetPolygonsMaterialIndex (3);
			body3.Transform (JSM.RotationZTransformation (-0.3));
			body3.Transform (JSM.TranslationTransformation (new JSM.Coord (0.0, -0.7, 0.5)));
			model.AddBody (body3);

			var box = JSM.GenerateCuboid (10, 10, 10);
			box.SetPolygonsMaterialIndex (0);
			JSM.MakeBodyInsideOut (box);
			box.Transform (JSM.TranslationTransformation (new JSM.Coord (0.0, 0.0, 4.5)));
			model.AddBody (box);
			
			return JSM.ConvertModelToTriangleModel (model, materials);
		}
		
		function Compile ()
		{
			var vertexShader = document.getElementById ('vertexshader').value;
			var fragmentShader = document.getElementById ('fragmentshader').value;
			var errorDiv = document.getElementById ('error');
			errorDiv.innerHTML = '';

			var canvas = document.getElementById ('example');
			var context = JSM.WebGLInitContext (canvas);
			var floatExtension = context.getExtension ('OES_texture_float');
			var shader = JSM.WebGLInitShaderProgram (context, vertexShader, fragmentShader, function (error) {
				errorDiv.innerHTML += error.replace ('\n', '<br>');
			});
			
			var vertices = new Float32Array ([-1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0]);
			var vertexAttribLocation = context.getAttribLocation (shader, 'aVertexPosition');
			var buffer = context.createBuffer ();
			context.bindBuffer (context.ARRAY_BUFFER, buffer);
			context.bufferData (context.ARRAY_BUFFER, vertices, context.STATIC_DRAW);
			context.vertexAttribPointer (vertexAttribLocation, 2, context.FLOAT, false, 0, 0);
			context.enableVertexAttribArray (vertexAttribLocation);
			context.bindBuffer (context.ARRAY_BUFFER, null);

			context.uniform1f (context.getUniformLocation (shader, 'uWidth'), canvas.width);
			context.uniform1f (context.getUniformLocation (shader, 'uHeight'), canvas.height);
			
			context.clear (context.COLOR_BUFFER_BIT | context.DEPTH_BUFFER_BIT);
			context.drawArrays (context.TRIANGLE_FAN, 0, 4);			
		}

		function TextAreaKeyDown (event)
		{
			if (event.which == 9) {
				event.preventDefault ();
				var selectionStart = this.selectionStart;
				this.value = this.value.substring (0, this.selectionStart) + '\t' + this.value.substring (this.selectionEnd);
				this.selectionEnd = selectionStart + 1; 
			}		
		}
		
		function ConvertBodyToShaderCode (body)
		{
			var triangleBody = new JSM.ConvertBodyToTriangleBody (body);
			triangleCount = triangleBody.TriangleCount ();
			
			var result = '';
			result += '\tint triangleCount = ' + triangleCount + ';\n';
			result += '\ttriangle triangles[' + triangleCount + '];\n';
			var i, triangle, v0, v1, v2, currentIntersection;
			for (i = 0; i < triangleCount; i++) {
				triangle = triangleBody.GetTriangle (i);
				v0 = triangleBody.GetVertex (triangle.v0);
				v1 = triangleBody.GetVertex (triangle.v1);
				v2 = triangleBody.GetVertex (triangle.v2);
				result += '\ttriangles[' + i + '].v0 = vec3 (' + v0.x + ', ' + v0.y + ', ' + v0.z + ');\n';
				result += '\ttriangles[' + i + '].v1 = vec3 (' + v1.x + ', ' + v1.y + ', ' + v1.z + ');\n';
				result += '\ttriangles[' + i + '].v2 = vec3 (' + v2.x + ', ' + v2.y + ', ' + v2.z + ');\n';
			}
			return result;
		}
		
		function ConvertCameraToShaderCode (camera)
		{
			var result = '';
			result += '\tcamera cam;\n';
			result += '\tcam.eye = vec3 (' + camera.eye.x + ', ' + camera.eye.y + ', ' + camera.eye.z + ');\n';
			result += '\tcam.center = vec3 (' + camera.center.x + ', ' + camera.center.y + ', ' + camera.center.z + ');\n';
			result += '\tcam.up = vec3 (' + camera.up.x + ', ' + camera.up.y + ', ' + camera.up.z + ');\n';
			return result;
		}

		function GenerateCode ()
		{
			var camera = new JSM.Camera (
				new JSM.Coord (4, 1, 2),
				new JSM.Coord (0, 0, 0),
				new JSM.Coord (0, 0, 1)
			);
			
			var body = JSM.GenerateCuboid (1, 1, 1);
			var generatedCode = '';
			generatedCode += ConvertBodyToShaderCode (body);
			generatedCode += ConvertCameraToShaderCode (camera);

			var fragmentShader = document.getElementById ('fragmentshader');
			fragmentShader.value = fragmentShader.value.replace ('// GENERATED CODE', generatedCode);
		}
	
	    window.onload = function ()
		{
			var vertexShader = document.getElementById ('vertexshader');
			var fragmentShader = document.getElementById ('fragmentshader');
			vertexShader.onkeydown = TextAreaKeyDown;
			fragmentShader.onkeydown = TextAreaKeyDown;

			GenerateCode ();
			Compile ();			
		}
	</script>

</head>

<body>
	<div>
<textarea id="vertexshader" class="shadertext">
precision highp float;
attribute vec2 aVertexPosition;
varying vec2 vVertexPosition;

void main (void) {
	vVertexPosition = (aVertexPosition + vec2 (1.0, 1.0)) / 2.0;
	gl_Position = vec4 (aVertexPosition.x, -aVertexPosition.y, 0.0, 1.0);
}
</textarea>
<textarea id="fragmentshader" class="shadertext">
precision highp float;
varying vec2 vVertexPosition;
uniform highp float uWidth;
uniform highp float uHeight;

struct triangle
{
	vec3 v0;
	vec3 v1;
	vec3 v2;
};

struct camera
{
	vec3 eye;
	vec3 center;
	vec3 up;
};

void main (void) {
// GENERATED CODE
	
	float x = floor (vVertexPosition.x * uWidth);
	float y = floor (vVertexPosition.y * uHeight);

	if (mod (x, 2.0) != mod (y, 2.0)) {
		gl_FragColor = vec4 (1.0, 1.0, 1.0, 1.0);
	} else {
		gl_FragColor = vec4 (0.0, 0.0, 0.0, 1.0);
	}
}
</textarea>
	</div>
	<div>
		<input type="button" value="render" onclick="Compile ();"></input>
	</div>
	<div id="error"></div>
	<canvas id="example" width="256" height="256"></canvas>
</body>

</html>
