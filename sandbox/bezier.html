<!--
	Author:		Kovacs Viktor
	Homepage:	http://www.kovacsv.hu
-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<script type="text/javascript" src="../build/three.min.js"></script>
<!-- JSModeler includes start -->
	<script type="text/javascript" src="../src/core/jsm.js"></script>
	<script type="text/javascript" src="../src/core/timer.js"></script>
	<script type="text/javascript" src="../src/geometry/determinant.js"></script>
	<script type="text/javascript" src="../src/geometry/matrix.js"></script>
	<script type="text/javascript" src="../src/geometry/coord.js"></script>
	<script type="text/javascript" src="../src/geometry/coordutils.js"></script>
	<script type="text/javascript" src="../src/geometry/coordsystem.js"></script>
	<script type="text/javascript" src="../src/geometry/coordsystemutils.js"></script>
	<script type="text/javascript" src="../src/geometry/sector.js"></script>
	<script type="text/javascript" src="../src/geometry/sectorutils.js"></script>
	<script type="text/javascript" src="../src/geometry/line.js"></script>
	<script type="text/javascript" src="../src/geometry/lineutils.js"></script>
	<script type="text/javascript" src="../src/geometry/transformation.js"></script>
	<script type="text/javascript" src="../src/geometry/transformationutils.js"></script>
	<script type="text/javascript" src="../src/geometry/plane.js"></script>
	<script type="text/javascript" src="../src/geometry/planeutils.js"></script>
	<script type="text/javascript" src="../src/geometry/projection.js"></script>
	<script type="text/javascript" src="../src/geometry/convexhull.js"></script>
	<script type="text/javascript" src="../src/geometry/polygon.js"></script>
	<script type="text/javascript" src="../src/geometry/polygonutils.js"></script>
	<script type="text/javascript" src="../src/geometry/bsptree.js"></script>
	<script type="text/javascript" src="../src/modeler/body.js"></script>
	<script type="text/javascript" src="../src/modeler/bodyutils.js"></script>
	<script type="text/javascript" src="../src/modeler/adjacencylist.js"></script>
	<script type="text/javascript" src="../src/modeler/cututils.js"></script>
	<script type="text/javascript" src="../src/modeler/textureutils.js"></script>
	<script type="text/javascript" src="../src/modeler/model.js"></script>
	<script type="text/javascript" src="../src/modeler/material.js"></script>
	<script type="text/javascript" src="../src/modeler/generator.js"></script>
	<script type="text/javascript" src="../src/modeler/solidgenerator.js"></script>
	<script type="text/javascript" src="../src/modeler/camera.js"></script>
	<script type="text/javascript" src="../src/modeler/exporter.js"></script>
	<script type="text/javascript" src="../src/extras/extgenerator.js"></script>
	<script type="text/javascript" src="../src/extras/painter.js"></script>
	<script type="text/javascript" src="../src/extras/drawing.js"></script>
	<script type="text/javascript" src="../src/extras/subdivision.js"></script>
	<script type="text/javascript" src="../src/extras/svgtomodel.js"></script>
	<script type="text/javascript" src="../src/extras/csg.js"></script>
	<script type="text/javascript" src="../src/extras/surfaces.js"></script>
	<script type="text/javascript" src="../src/viewer/mouse.js"></script>
	<script type="text/javascript" src="../src/viewer/touch.js"></script>
	<script type="text/javascript" src="../src/viewer/converter.js"></script>
	<script type="text/javascript" src="../src/viewer/viewer.js"></script>
	<script type="text/javascript" src="../src/viewer/softwareviewer.js"></script>
<!-- JSModeler includes end -->
	<title>Example</title>

	<script type="text/javascript">
		var viewer = null;
		var scp = null;
		var mouseData = null;
		
		function AddSurfaceControlPointsModel (scp)
		{
			var scpModel = scp.GenerateModel (0.02, false);
			var meshes = JSM.ConvertModelToThreeMeshes (scpModel);
			
			var n = scp.GetNValue ();
			var m = scp.GetMValue ();
			
			var i, j, k, mesh, point;
			for (k = 0; k < meshes.length; k++) {
				mesh = meshes[k];
				i = parseInt (k / (m + 1));
				j = parseInt (k % (m + 1));
				point = scp.GetControlPoint (i, j);
				mesh.position.x = point.x;
				mesh.position.y = point.y;
				mesh.position.z = point.z;
				mesh.controlPointIndices = [i, j];
				viewer.AddMesh (mesh);
			}

		/*
			var n = scp.GetNValue ();
			var m = scp.GetMValue ();		
		
			var geometry = new THREE.Geometry ();
			var i, j, point, vertex;
			for (i = 0; i <= n; i++) {
				for (j = 0; j <= m; j++) {
					point = scp.GetControlPoint (i, j);
					vertex = new THREE.Vector3 ();
					vertex.x = point.x;
					vertex.y = point.y;
					vertex.z = point.z;
					geometry.vertices.push (vertex);
				}
			}

			var material = new THREE.ParticleBasicMaterial ({
				size: 0.1,
				color : 0xcc0000,
				depthTest: false
			});
			var particle = new THREE.ParticleSystem (geometry, material);
			viewer.scene.add (particle);		
		*/
		}
		
		function AddBezierSurfaceModel (scp)
		{
			function RemoveNonControlPointMeshes ()
			{
				var current;
				var i;
				for (i = 0; i < viewer.scene.children.length; i++) {
					current = viewer.scene.children[i];
					if (current instanceof THREE.Mesh && current.controlPointIndices === undefined) {
						viewer.scene.remove (current);
						i--;
					}
				}
			}
		
			RemoveNonControlPointMeshes ();
			var body = JSM.GenerateBezierSurface (scp, 10, 10, false);
			var materials = new JSM.Materials ();
			JSM.GenerateRandomMaterials (body, materials, true);
			var meshes = JSM.ConvertBodyToThreeMeshes (body, materials);
			var i;
			for (i = 0; i < meshes.length; i++) {
				viewer.AddMesh (meshes[i]);
			}
		}
		
		function OnMouseDown (event)
		{
			var foundObject = null;
			var objects = viewer.GetObjectsUnderMouse ();
			var i;
			for (i = 0; i < objects.length; i++) {
				if (objects[i].object instanceof THREE.Mesh) {
					if (objects[i].object.controlPointIndices !== undefined) {
						foundObject = objects[i].object;
						break;
					}
				}
			}
			
			if (foundObject === null) {
				return;
			}
			
			mouseData = {
				foundObject : foundObject,
				originalObjectPos : foundObject.position.clone (),
				originalMousePos : [viewer.mouse.currX, viewer.mouse.currY]
			};
			viewer.settings.cameraDisableOrbit = true;
		}
		
		function OnMouseUp (event)
		{
			if (mouseData === null) {
				return;
			}
			
			var indices = mouseData.foundObject.controlPointIndices;
			var point = scp.GetControlPoint (indices[0], indices[1]);
			point.x = mouseData.foundObject.position.x;
			point.y = mouseData.foundObject.position.y;
			point.z = mouseData.foundObject.position.z;
			AddBezierSurfaceModel (scp);

			mouseData = null;
			viewer.settings.cameraDisableOrbit = false;
		}
		
		function OnMouseMove (event)
		{
			if (mouseData === null) {
				return;
			}
			
			var currentPos = [viewer.mouse.currX, viewer.mouse.currY];
			var ratio = 0.005;
			var diff = (currentPos[1] - mouseData.originalMousePos[1]) * ratio;
			mouseData.foundObject.position.z = mouseData.originalObjectPos.z - diff;
		}
		
		function Load ()
		{
			var TextureLoaded = function () {
				viewer.Draw ();
			};

			var viewerSettings = {
				cameraEyePosition : [-2.0, -1.5, 1.0],
				cameraCenterPosition : [0.0, 0.0, 0.0],
				cameraUpVector : [0, 0, 1]
			};

			viewer = new JSM.Viewer ();
			viewer.Start ('example', viewerSettings);
			
			document.addEventListener ('mousemove', OnMouseMove, false);
			document.addEventListener ('mouseup', OnMouseUp);
			viewer.canvas.addEventListener ('mousedown', OnMouseDown);
			
			scp = new JSM.SurfaceControlPoints (3, 3);
			scp.InitPlanar (1, 1);

			scp.points[1][1].z = 0.2;
			scp.points[1][2].z = 0.2;
			scp.points[2][1].z = 0.0;
			scp.points[2][2].z = 0.2;

			AddSurfaceControlPointsModel (scp);
			AddBezierSurfaceModel (scp);		
					
			viewer.FitInWindow ();
			viewer.Draw ();
		}
	
	    window.onload = function ()
		{
			Load ();			
		}
	</script>

</head>

<body>
	<canvas id="example" width="800" height="500" style="border : 1px solid #000000;"></canvas>
</body>

</html>
