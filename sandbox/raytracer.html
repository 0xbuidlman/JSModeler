<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<script type="text/javascript" src="../build/three.min.js"></script>
<!-- JSModeler includes start -->
	<script type="text/javascript" src="../src/core/jsm.js"></script>
	<script type="text/javascript" src="../src/core/timer.js"></script>
	<script type="text/javascript" src="../src/core/algorithm.js"></script>
	<script type="text/javascript" src="../src/core/async.js"></script>
	<script type="text/javascript" src="../src/core/check.js"></script>
	<script type="text/javascript" src="../src/geometry/coord.js"></script>
	<script type="text/javascript" src="../src/geometry/determinant.js"></script>
	<script type="text/javascript" src="../src/geometry/coordutils.js"></script>
	<script type="text/javascript" src="../src/geometry/matrix.js"></script>
	<script type="text/javascript" src="../src/geometry/coordsystem.js"></script>
	<script type="text/javascript" src="../src/geometry/coordsystemutils.js"></script>
	<script type="text/javascript" src="../src/geometry/sector.js"></script>
	<script type="text/javascript" src="../src/geometry/sectorutils.js"></script>
	<script type="text/javascript" src="../src/geometry/line.js"></script>
	<script type="text/javascript" src="../src/geometry/lineutils.js"></script>
	<script type="text/javascript" src="../src/geometry/box.js"></script>
	<script type="text/javascript" src="../src/geometry/boxutils.js"></script>
	<script type="text/javascript" src="../src/geometry/transformation.js"></script>
	<script type="text/javascript" src="../src/geometry/transformationutils.js"></script>
	<script type="text/javascript" src="../src/geometry/plane.js"></script>
	<script type="text/javascript" src="../src/geometry/planeutils.js"></script>
	<script type="text/javascript" src="../src/geometry/projection.js"></script>
	<script type="text/javascript" src="../src/geometry/convexhull.js"></script>
	<script type="text/javascript" src="../src/geometry/polygon.js"></script>
	<script type="text/javascript" src="../src/geometry/polygonutils.js"></script>
	<script type="text/javascript" src="../src/geometry/octree.js"></script>
	<script type="text/javascript" src="../src/geometry/bsptree.js"></script>
	<script type="text/javascript" src="../src/geometry/utilities.js"></script>
	<script type="text/javascript" src="../src/geometry/ray.js"></script>
	<script type="text/javascript" src="../src/modeler/body.js"></script>
	<script type="text/javascript" src="../src/modeler/model.js"></script>
	<script type="text/javascript" src="../src/modeler/color.js"></script>
	<script type="text/javascript" src="../src/modeler/light.js"></script>
	<script type="text/javascript" src="../src/modeler/material.js"></script>
	<script type="text/javascript" src="../src/modeler/adjacencylist.js"></script>
	<script type="text/javascript" src="../src/modeler/bodyutils.js"></script>
	<script type="text/javascript" src="../src/modeler/textureutils.js"></script>
	<script type="text/javascript" src="../src/modeler/cututils.js"></script>
	<script type="text/javascript" src="../src/modeler/generator.js"></script>
	<script type="text/javascript" src="../src/modeler/camera.js"></script>
	<script type="text/javascript" src="../src/modeler/explode.js"></script>
	<script type="text/javascript" src="../src/modeler/exporter.js"></script>
	<script type="text/javascript" src="../src/modeler/trianglebody.js"></script>
	<script type="text/javascript" src="../src/modeler/trianglemodel.js"></script>
	<script type="text/javascript" src="../src/modeler/converter.js"></script>
	<script type="text/javascript" src="../src/modeler/rayutils.js"></script>
	<script type="text/javascript" src="../src/import/binaryreader.js"></script>
	<script type="text/javascript" src="../src/import/importer.js"></script>
	<script type="text/javascript" src="../src/import/importer3ds.js"></script>
	<script type="text/javascript" src="../src/import/importerobj.js"></script>
	<script type="text/javascript" src="../src/import/importerstl.js"></script>
	<script type="text/javascript" src="../src/import/importercommon.js"></script>
	<script type="text/javascript" src="../src/extras/solidgenerator.js"></script>
	<script type="text/javascript" src="../src/extras/extgenerator.js"></script>
	<script type="text/javascript" src="../src/extras/painter.js"></script>
	<script type="text/javascript" src="../src/extras/drawing.js"></script>
	<script type="text/javascript" src="../src/extras/subdivision.js"></script>
	<script type="text/javascript" src="../src/extras/svgtomodel.js"></script>
	<script type="text/javascript" src="../src/extras/csg.js"></script>
	<script type="text/javascript" src="../src/extras/curves.js"></script>
	<script type="text/javascript" src="../src/renderer/renderer.js"></script>
	<script type="text/javascript" src="../src/renderer/pointcloudrenderer.js"></script>
	<script type="text/javascript" src="../src/renderer/rendererconverter.js"></script>
	<script type="text/javascript" src="../src/viewer/jsonfileloader.js"></script>
	<script type="text/javascript" src="../src/viewer/mouse.js"></script>
	<script type="text/javascript" src="../src/viewer/touch.js"></script>
	<script type="text/javascript" src="../src/viewer/navigation.js"></script>
	<script type="text/javascript" src="../src/viewer/softwareviewer.js"></script>
	<script type="text/javascript" src="../src/viewer/spriteviewer.js"></script>
	<script type="text/javascript" src="../src/viewer/viewer.js"></script>
	<script type="text/javascript" src="../src/viewer/pointcloudviewer.js"></script>
	<script type="text/javascript" src="../src/three/threeconverter.js"></script>
	<script type="text/javascript" src="../src/three/threeviewer.js"></script>
<!-- JSModeler includes end -->
	<title>Example</title>

	<script type="text/javascript">
		JSM.RayTracerImage = function (camera, resolutionX, resolutionY, distance)
		{
			var imageWidth = 2.0 * distance * Math.tan (camera.fieldOfView / 2.0);
			var imageHeight = 2.0 * distance * Math.tan (camera.fieldOfView / 2.0);
			this.fieldWidth = imageWidth / resolutionX;
			this.fieldHeight = imageHeight / resolutionY;
			
			var eyeToCenter = JSM.VectorNormalize (JSM.CoordSub (camera.center, camera.eye));
			this.xDirection = JSM.VectorNormalize (JSM.VectorCross (eyeToCenter, camera.up));
			this.yDirection = JSM.VectorNormalize (JSM.VectorCross (this.xDirection, eyeToCenter));
			
			var pyramidBottom = JSM.CoordOffset (camera.eye, eyeToCenter, distance);
			this.bottomLeft = pyramidBottom;
			this.bottomLeft = JSM.CoordOffset (this.bottomLeft, JSM.VectorMultiply (this.xDirection, -1.0), imageWidth / 2.0);
			this.bottomLeft = JSM.CoordOffset (this.bottomLeft, JSM.VectorMultiply (this.yDirection, -1.0), imageHeight / 2.0);
		};
		
		JSM.RayTracerImage.prototype.GetFieldCenter = function (x, y)
		{
			var result = this.bottomLeft.Clone ();
			result = JSM.CoordOffset (result, this.xDirection, x * this.fieldWidth + this.fieldWidth / 2.0);
			result = JSM.CoordOffset (result, this.yDirection, y * this.fieldHeight + this.fieldHeight / 2.0);
			return result;
		};
		
		JSM.RayTracer = function ()
		{
			this.canvas = null;
			this.context = null;
		};

		JSM.RayTracer.prototype.Init = function (canvas)
		{
			this.canvas = canvas;
			this.context = this.canvas.getContext ('2d');
		};

		JSM.RayTracer.prototype.Render = function (model, camera, light)
		{
			function RenderRow ()
			{
				var colors = [];
				var currentColumn, color;
				for (currentColumn = 0; currentColumn < this.canvas.width; currentColumn++) {
					color = this.GetPixelColor (currentColumn, this.canvas.height - currentRow - 1, model, camera, light, image);
					colors.push (color);
				}
				this.PutPixelRow (currentRow, colors);
				currentRow++;
				return true;
			}
			
			var image = new JSM.RayTracerImage (camera, this.canvas.width, this.canvas.height, 1.0);
			
			var currentRow = 0;
			var asyncEnv = new JSM.AsyncEnvironment ();
			JSM.AsyncRunTask (RenderRow.bind (this), asyncEnv, this.canvas.height, 0, null);
		};
	
		JSM.RayTracer.prototype.GetPixelColor = function (x, y, model, camera, light, image)
		{
			function GetNormal (body, triangle, intersection)
			{
				var normal = null;
				if (triangle.curve == -1) {
					normal = body.GetNormal (triangle.n0);
				} else {
					var v0 = body.GetVertex (triangle.v0);
					var v1 = body.GetVertex (triangle.v1);
					var v2 = body.GetVertex (triangle.v2);
					var n0 = body.GetNormal (triangle.n0);
					var n1 = body.GetNormal (triangle.n1);
					var n2 = body.GetNormal (triangle.n2);
					normal = JSM.BarycentricInterpolation (v0, v1, v2, n0, n1, n2, intersection.position);
				}
				return normal;
			}
		
			var fieldCenter = image.GetFieldCenter (x, y);
			var ray = new JSM.Ray (camera.eye, JSM.CoordSub (fieldCenter, camera.eye));
			var intersection = JSM.RayTriangleModelIntersection (ray, model);
			if (intersection == null) {
				return {r : 0, g : 0, b : 0};
			}
			
			var body = model.GetBody (intersection.bodyIndex);
			var triangle = body.GetTriangle (intersection.triangleIndex);
			var material = model.GetMaterial (triangle.mat);
			var intersectionPosition = intersection.position;
			var intersectionNormal = GetNormal (body, triangle, intersectionPosition);
			var color = this.PhongShading (material, light, intersectionPosition, intersectionNormal);
			return color;
		};

		JSM.RayTracer.prototype.PhongShading = function (material, light, shadedPoint, shadedPointNormal)
		{
			function Clamp (value)
			{
				if (value.x < 0.0) { value.x = 0.0; }
				if (value.y < 0.0) { value.y = 0.0; }
				if (value.z < 0.0) { value.z = 0.0; }
				if (value.x > 1.0) { value.x = 1.0; }
				if (value.y > 1.0) { value.y = 1.0; }
				if (value.z > 1.0) { value.z = 1.0; }
			}
		
			var lightPosition = new JSM.Coord (4, 2, 3);
			
			var lightDiffuseColor = new JSM.Coord (light.diffuse[0], light.diffuse[1], light.diffuse[2]);
			var materialDiffuseColor = new JSM.Coord (material.diffuse[0], material.diffuse[1], material.diffuse[2]);
			var lightDirection = JSM.VectorNormalize (JSM.CoordSub (lightPosition, shadedPoint));

			var lightNormalProduct = JSM.VectorDot (lightDirection, shadedPointNormal);
			var diffuseCoeff = Math.max (lightNormalProduct, 0.0);
			
			var diffuseColor = JSM.CoordAdd (lightDiffuseColor, materialDiffuseColor);
			var color = JSM.VectorMultiply (diffuseColor, diffuseCoeff);
			Clamp (color);
			return {r : color.x * 255, g : color.y * 255, b : color.z * 255};
		};
		
		JSM.RayTracer.prototype.PutPixelRow = function (rowIndex, colors)
		{
			var imageData = this.context.createImageData (colors.length, 1);
			var i, color;
			for (i = 0; i < colors.length; i++) {
				color = colors[i];
				imageData.data[4 * i + 0] = color.r;
				imageData.data[4 * i + 1] = color.g;
				imageData.data[4 * i + 2] = color.b;
				imageData.data[4 * i + 3] = 255;
			}
			this.context.putImageData (imageData, 0, rowIndex);
		};	

		function Load ()
		{
			function GetModel ()
			{
				var model = new JSM.Model ();
				var materials = new JSM.Materials ();
				materials.AddMaterial (new JSM.Material ({ambient : 0x00cc00, diffuse : 0x00cc00}));
				var body = JSM.GenerateCuboid (1, 1, 1);
				body.SetPolygonsMaterialIndex (0);
				model.AddBody (body);
				var box = JSM.GenerateCuboid (10, 10, 10);
				box.Transform (JSM.TranslationTransformation (new JSM.Coord (0.0, 0.0, 4.5)));
				JSM.MakeBodyInsideOut (box);
				model.AddBody (box);
				return JSM.ConvertModelToTriangleModel (model, materials);
			}
			
			var model = GetModel ();
			var camera = new JSM.Camera (
				new JSM.Coord (3, 1, 2),
				new JSM.Coord (0, 0, 0),
				new JSM.Coord (0, 0, 1)
			);
			var light = {
				diffuse : [0.1, 0.1, 0.1]
			};			
			
			var canvas = document.getElementById ('example');
			var rayTracer = new JSM.RayTracer ();
			rayTracer.Init (canvas);
			rayTracer.Render (model, camera, light);
		}
	
	    window.onload = function ()
		{
			Load ();			
		}
	</script>

</head>

<body>
	<canvas id="example" width="200" height="200"></canvas>
</body>

</html>
