<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<title>Example</title>

	<script type="text/javascript" src="fragmentrenderer.js"></script>
	<script type="text/javascript">
		WebGLInitContext = function (canvas)
		{
			if (canvas === null) {
				return null;
			}
			
			if (canvas.getContext === undefined) {
				return null;
			}
			
			var context = canvas.getContext ('webgl') || canvas.getContext ('experimental-webgl');
			if (context === null) {
				return null;
			}
			
			context.viewportWidth = canvas.width;
			context.viewportHeight = canvas.height;
			context.viewport (0, 0, context.viewportWidth, context.viewportHeight);
			context.clearColor (1.0, 1.0, 1.0, 1.0);
			return context;
		};
	
		WebGLInitShaderProgram = function (context, vertexShader, fragmentShader, onError)
		{
			function CompileShader (context, script, type, onError)
			{
				var shader = context.createShader (type);
				context.shaderSource (shader, script);
				context.compileShader (shader);
				if (!context.getShaderParameter (shader, context.COMPILE_STATUS)) {
					if (onError !== undefined && onError !== null) {
						onError (context.getShaderInfoLog (shader));
					}
					return null;
				}
				return shader;
			}
			
			function CreateShader (context, fragmentShaderScript, vertexShaderScript, onError)
			{
				var fragmentShader = CompileShader (context, fragmentShaderScript, context.FRAGMENT_SHADER, onError);
				var vertexShader = CompileShader (context, vertexShaderScript, context.VERTEX_SHADER, onError);
				if (fragmentShader === null || vertexShader === null) {
					return null;
				}

				var shaderProgram = context.createProgram ();
				context.attachShader (shaderProgram, vertexShader);
				context.attachShader (shaderProgram, fragmentShader);
				context.linkProgram (shaderProgram);
				if (!context.getProgramParameter (shaderProgram, context.LINK_STATUS)) {
					return null;
				}
				
				return shaderProgram;
			}
			
			var shader = CreateShader (context, fragmentShader, vertexShader, onError);
			if (shader == null) {
				return null;
			}
			
			context.useProgram (shader);
			return shader;
		};
		
		WebGLCreateBuffer = function (context, bufferData, attribLocation)
		{
			var buffer = context.createBuffer ();
			context.bindBuffer (context.ARRAY_BUFFER, buffer);
			context.bufferData (context.ARRAY_BUFFER, bufferData, context.STATIC_DRAW);
			context.vertexAttribPointer (attribLocation, 2, context.FLOAT, false, 0, 0);
			context.enableVertexAttribArray (attribLocation);
			context.bindBuffer (context.ARRAY_BUFFER, null);		
		};
		
		WebGLCreateTextureBuffer = function (context, imageData)
		{
			var textureBuffer = context.createTexture ();
			context.bindTexture (context.TEXTURE_2D, textureBuffer);
			context.texParameteri (context.TEXTURE_2D, context.TEXTURE_WRAP_S, context.CLAMP_TO_EDGE);
			context.texParameteri (context.TEXTURE_2D, context.TEXTURE_WRAP_T, context.CLAMP_TO_EDGE);
			context.texParameteri (context.TEXTURE_2D, context.TEXTURE_MIN_FILTER, context.NEAREST);
			context.texParameteri (context.TEXTURE_2D, context.TEXTURE_MAG_FILTER, context.NEAREST);
			context.texImage2D (context.TEXTURE_2D, 0, context.RGBA, context.RGBA, context.UNSIGNED_BYTE, imageData);
			context.bindTexture (context.TEXTURE_2D, null);
			return textureBuffer;
		};
		
		WebGLCreateTextureBuffersFromFiles = function (context, fileNames, onLoaded)
		{
			function CreateTexture (fileNames, index)
			{
				var fileName = fileNames[index];
				var imageData = new Image ();
				imageData.src = fileName;
				imageData.onload = function () {
					textureBuffers[index] = WebGLCreateTextureBuffer (context, imageData);
					remainingFiles = remainingFiles - 1;
					if (remainingFiles === 0) {
						onLoaded (textureBuffers);
					}
				}
			}
		
			var remainingFiles = fileNames.length;
			var textureBuffers = [];
			for (i = 0; i < fileNames.length; i++) {
				textureBuffers.push (null);
			}
		
			var i;
			for (i = 0; i < fileNames.length; i++) {
				CreateTexture (fileNames, i);
			}
		};

		function Load ()
		{
			var vertexShader = [
				'precision highp float;',
				'attribute vec2 aVertexPosition;',
				'varying vec2 vVertexPosition;',
				'void main (void) {',
				'	vVertexPosition = (aVertexPosition + vec2 (1.0, 1.0)) / 2.0;',
				'	gl_Position = vec4 (aVertexPosition.x, -aVertexPosition.y, 0.0, 1.0);',
				'}'
			].join('\n');

			var fragmentShader = [
				'precision highp float;',
				'varying vec2 vVertexPosition;',
				'uniform sampler2D uSampler0;',
				'uniform sampler2D uSampler1;',
				'void main (void) {',
				'	vec4 color0 = texture2D (uSampler0, vVertexPosition);',
				'	vec4 color1 = texture2D (uSampler1, vVertexPosition);',
				'	gl_FragColor = color0 * color1;',
				'}'
			].join('\n');

			var canvas = document.getElementById ('example');
			var context = WebGLInitContext (canvas);
			var shader = WebGLInitShaderProgram (context, vertexShader, fragmentShader, function (error) {
				alert (error);
			});
			
			var vertices = new Float32Array ([-1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0]);
			var vertexAttribLocation = context.getAttribLocation (shader, 'aVertexPosition');
			var vertexBuffer = WebGLCreateBuffer (context, vertices, vertexAttribLocation);

			var samplerUniform0 = context.getUniformLocation (shader, 'uSampler0');
			var samplerUniform1 = context.getUniformLocation (shader, 'uSampler1');
			context.uniform1i (samplerUniform0, 0);
			context.uniform1i (samplerUniform1, 1);

			WebGLCreateTextureBuffersFromFiles (context, ['texture1.png', 'texture2.png'], function (textureBuffers) {
				context.activeTexture (context.TEXTURE0);
				context.bindTexture (context.TEXTURE_2D, textureBuffers[0]);
				context.activeTexture (context.TEXTURE1);
				context.bindTexture (context.TEXTURE_2D, textureBuffers[1]);
				
				context.clear (context.COLOR_BUFFER_BIT | context.DEPTH_BUFFER_BIT);
				context.drawArrays (context.TRIANGLE_FAN, 0, 4);
			});
		}
	
	    window.onload = function ()
		{
			Load ();			
		}
	</script>

</head>

<body>
	<canvas id="example" width="256" height="256"></canvas>
</body>

</html>
